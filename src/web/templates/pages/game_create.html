{% extends "base.html" %}

{% block title %}{{ _('ui.game.add_game') }} - {{ _('ui.navigation.brand_name') }}{% endblock %}

{% block content %}
<div class="row justify-content-center">
	<div class="col-md-8">
		<h1 class="mb-4">{{ _('ui.game.add_game') }}</h1>

		{% if error %}
		<div class="alert alert-danger" role="alert">
			{{ error }}
		</div>
		{% endif %}

		<div class="card">
			<div class="card-body">
				<form method="POST" action="/games/create" id="gameCreateForm">
					<div class="mb-3">
						<label for="path" class="form-label">1. {{ _('ui.game.path') }}</label>
						<select class="form-select" id="path" name="path" required>
							<option value="">{{ _('ui.game.select_path_placeholder') }}</option>
							{% if available_game_paths %}
								{% for path in available_game_paths %}
								<option value="{{ path }}">{{ path }}</option>
								{% endfor %}
							{% else %}
								<option value="" disabled>{{ _('ui.game.no_paths_found') }}</option>
							{% endif %}
						</select>
						<div class="form-text">{{ _('ui.game.path_help') }}</div>
					</div>

					<div class="mb-3">
						<label for="game_type" class="form-label">2. Game Type</label>
						<select class="form-select" id="game_type" name="game_type" required>
							<option value="">Select game type...</option>
							{% for game in supported_games %}
							<option value="{{ game.name }}">{{ game.name }}</option>
							{% endfor %}
						</select>
						<div class="form-text">Select which King's Bounty game this is</div>
					</div>

					<div class="mb-3" id="campaignSection" style="display: none;">
						<label for="campaign_name" class="form-label">3. Campaign</label>
						<select class="form-select" id="campaign_name" name="campaign_name">
							<option value="">Select campaign...</option>
						</select>
						<div class="form-text">This game requires campaign selection</div>
					</div>

					<div class="mb-3" id="customCampaignSection" style="display: none;">
						<label for="custom_campaign_session" class="form-label">Custom Campaign Session Directory</label>
						<input type="text"
							   class="form-control"
							   id="custom_campaign_session"
							   name="custom_campaign_session"
							   placeholder="e.g., my_custom_campaign">
						<div class="form-text">
							Enter the session directory name (will be validated against &lt;game_path&gt;/sessions/&lt;session&gt;)
						</div>
					</div>

					<div class="mb-3" id="scanSessionsSection" style="display: none;">
						<button type="button"
								class="btn btn-secondary btn-sm"
								id="scanSessionsBtn">
							Scan Available Sessions
						</button>
						<div id="availableSessions" class="mt-2"></div>
					</div>

					<div class="mb-3">
						<label for="name" class="form-label">4. {{ _('ui.game.name') }}</label>
						<input type="text" class="form-control" id="name" name="name" required>
						<div class="form-text">Display name for this game (auto-filled based on selections)</div>
					</div>

					<div class="mb-3">
						<div class="card bg-light">
							<div class="card-body">
								<h6 class="card-title">Computed Configuration:</h6>
								<p class="mb-1"><strong>Sessions:</strong> <span id="displaySessions">-</span></p>
								<p class="mb-0"><strong>Saves Pattern:</strong> <code id="displayPattern">-</code></p>
							</div>
						</div>
					</div>

					<div class="d-grid gap-2">
						<button type="submit" class="btn btn-primary">{{ _('ui.game.add_button') }}</button>
						<a href="/games" class="btn btn-secondary">{{ _('ui.common.cancel') }}</a>
					</div>
				</form>
			</div>
		</div>
	</div>
</div>

<script>
const supportedGames = {{ supported_games|tojson }};

// Game type change handler
document.getElementById('game_type').addEventListener('change', function() {
	const selectedGameName = this.value;
	const selectedGame = supportedGames.find(g => g.name === selectedGameName);

	// Hide all campaign-related sections
	document.getElementById('customCampaignSection').style.display = 'none';
	document.getElementById('scanSessionsSection').style.display = 'none';
	document.getElementById('custom_campaign_session').value = '';
	document.getElementById('availableSessions').innerHTML = '';

	const campaignSection = document.getElementById('campaignSection');
	const campaignSelect = document.getElementById('campaign_name');

	if (selectedGame && selectedGame.campaigns && selectedGame.campaigns.length > 0) {
		campaignSelect.innerHTML = '<option value="">Select campaign...</option>';
		campaignSection.style.display = 'block';
		campaignSelect.required = true;

		selectedGame.campaigns.forEach(campaign => {
			const option = document.createElement('option');
			option.value = campaign.name;
			option.textContent = campaign.name;
			campaignSelect.appendChild(option);
		});

		const customOption = document.createElement('option');
		customOption.value = 'custom';
		customOption.textContent = 'Custom Campaign...';
		campaignSelect.appendChild(customOption);
	} else {
		campaignSection.style.display = 'none';
		campaignSelect.required = false;
		campaignSelect.value = '';
	}

	delete document.getElementById('name').dataset.userModified;
	updateNameField();
	updateComputedDisplay();
});

// Campaign selection change handler
document.getElementById('campaign_name').addEventListener('change', function() {
	const customSection = document.getElementById('customCampaignSection');
	const scanSection = document.getElementById('scanSessionsSection');

	if (this.value === 'custom') {
		customSection.style.display = 'block';
		scanSection.style.display = 'block';
	} else {
		customSection.style.display = 'none';
		scanSection.style.display = 'none';
	}

	updateNameField();
	updateComputedDisplay();
});

// Custom campaign session input handler
document.getElementById('custom_campaign_session').addEventListener('input', function() {
	updateNameField();
	updateComputedDisplay();
});

// Path selection handler
document.getElementById('path').addEventListener('change', function() {
	updateNameField();
});

// Update name field based on selections
function updateNameField() {
	const pathSelect = document.getElementById('path');
	const gameTypeSelect = document.getElementById('game_type');
	const campaignSelect = document.getElementById('campaign_name');
	const nameInput = document.getElementById('name');

	if (!nameInput.dataset.userModified) {
		const selectedGame = supportedGames.find(g => g.name === gameTypeSelect.value);
		let name = pathSelect.value || '';

		if (selectedGame) {
			// If game has campaigns and one is selected (not custom)
			if (campaignSelect.value && campaignSelect.value !== 'custom') {
				const gamePart = selectedGame.name.split(' / ')[0];
				const campaignPart = campaignSelect.options[campaignSelect.selectedIndex].text.split(' / ')[0];
				name = `${gamePart} / ${campaignPart}`;
			}
			// If game has no campaigns, use game name
			else if (!selectedGame.campaigns || selectedGame.campaigns.length === 0) {
				name = selectedGame.name;
			}
		}

		nameInput.value = name;
	}
}

// Track manual name edits
document.getElementById('name').addEventListener('input', function() {
	this.dataset.userModified = 'true';
});

// Update computed display
function updateComputedDisplay() {
	const gameTypeSelect = document.getElementById('game_type');
	const campaignSelect = document.getElementById('campaign_name');
	const customSessionInput = document.getElementById('custom_campaign_session');

	const selectedGame = supportedGames.find(g => g.name === gameTypeSelect.value);

	if (!selectedGame) {
		document.getElementById('displaySessions').textContent = '-';
		document.getElementById('displayPattern').textContent = '-';
		return;
	}

	let campaignSession = null;

	if (campaignSelect.value === 'custom') {
		campaignSession = customSessionInput.value.trim() || null;
	} else if (campaignSelect.value) {
		const selectedCampaign = selectedGame.campaigns.find(c => c.name === campaignSelect.value);
		if (selectedCampaign) {
			campaignSession = selectedCampaign.session;
		}
	}

	// Compute sessions
	const sessions = campaignSession
		? [selectedGame.session, campaignSession]
		: [selectedGame.session];

	// Compute saves pattern
	let pattern = selectedGame.saves_pattern || '';
	if (campaignSession) {
		pattern = pattern.replace('{campaign_session}', campaignSession);
	} else {
		pattern = pattern.replace('{campaign_session}_', '').replace('_{campaign_session}', '');
	}

	document.getElementById('displaySessions').textContent = JSON.stringify(sessions);
	document.getElementById('displayPattern').textContent = pattern;
}

// Scan sessions button
document.getElementById('scanSessionsBtn').addEventListener('click', async function() {
	const pathSelect = document.getElementById('path');
	const path = pathSelect.value;

	if (!path) {
		alert('Please select a game path first');
		return;
	}

	// Make API call to scan sessions directory
	try {
		const response = await fetch(`/api/games/scan-sessions?path=${encodeURIComponent(path)}`);
		const data = await response.json();

		const container = document.getElementById('availableSessions');
		if (data.sessions && data.sessions.length > 0) {
			container.innerHTML = '<strong>Available sessions:</strong><ul>' +
				data.sessions.map(s => `<li><code>${s}</code></li>`).join('') +
				'</ul>';
		} else {
			container.innerHTML = '<em>No sessions found or path not accessible</em>';
		}
	} catch (err) {
		console.error('Failed to scan sessions:', err);
		alert('Failed to scan sessions directory');
	}
});
</script>
{% endblock %}
