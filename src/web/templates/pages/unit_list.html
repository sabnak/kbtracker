{% extends "base.html" %}

{% block title %}Units - King's Bounty Tracker{% endblock %}

{% block content %}
<div class="row">
	<div class="col-md-12">
		<h1 class="mb-4">Units for {{ game.name }}</h1>

		<!-- Units Count Info -->
		{% if units %}
		<div class="alert alert-info">
			<strong>Found {{ units|length }} unit(s)</strong>
		</div>
		{% endif %}

		{% if units %}
		<div class="table-responsive">
			<table class="table table-striped table-hover">
				<thead>
					<tr>
						<th class="sortable {% if sort_by == 'name' %}sorted sorted-{{ sort_order }}{% endif %}"
							data-sort="name">
							Name
							<span class="sort-indicator">
								{% if sort_by == 'name' %}
									{% if sort_order == 'asc' %}↑{% else %}↓{% endif %}
								{% else %}
									<span class="hover-icon">↕</span>
								{% endif %}
							</span>
						</th>
						<th class="sortable {% if sort_by == 'race' %}sorted sorted-{{ sort_order }}{% endif %}"
							data-sort="race">
							Race
							<span class="sort-indicator">
								{% if sort_by == 'race' %}
									{% if sort_order == 'asc' %}↑{% else %}↓{% endif %}
								{% else %}
									<span class="hover-icon">↕</span>
								{% endif %}
							</span>
						</th>
						<th class="sortable {% if sort_by == 'level' %}sorted sorted-{{ sort_order }}{% endif %}"
							data-sort="level">
							Level
							<span class="sort-indicator">
								{% if sort_by == 'level' %}
									{% if sort_order == 'asc' %}↑{% else %}↓{% endif %}
								{% else %}
									<span class="hover-icon">↕</span>
								{% endif %}
							</span>
						</th>
						<th class="sortable {% if sort_by == 'cost' %}sorted sorted-{{ sort_order }}{% endif %}"
							data-sort="cost">
							Cost
							<span class="sort-indicator">
								{% if sort_by == 'cost' %}
									{% if sort_order == 'asc' %}↑{% else %}↓{% endif %}
								{% else %}
									<span class="hover-icon">↕</span>
								{% endif %}
							</span>
						</th>
						<th class="sortable {% if sort_by == 'leadership' %}sorted sorted-{{ sort_order }}{% endif %}"
							data-sort="leadership">
							Leadership
							<span class="sort-indicator">
								{% if sort_by == 'leadership' %}
									{% if sort_order == 'asc' %}↑{% else %}↓{% endif %}
								{% else %}
									<span class="hover-icon">↕</span>
								{% endif %}
							</span>
						</th>
						<th>Attributes</th>
					</tr>
				</thead>
				<tbody>
					{% for unit in units %}
					<tr>
						<td>
							<strong>{{ unit.name }}</strong><br />
							<small class="text-muted text-xxs">id: {{ unit.id }} kb_id: {{ unit.kb_id }}</small>
						</td>
						<td style="white-space: nowrap;">{{ unit.race if unit.race else 'N/A' }}</td>
						<td style="white-space: nowrap;">
							{% if unit.level %}
							<span class="quality-{{ unit.level }}">{{ unit.level }}</span>
							{% else %}
							N/A
							{% endif %}
						</td>
						<td style="white-space: nowrap;">{{ unit.cost|format_price if unit.cost else 'N/A' }}</td>
						<td style="white-space: nowrap;">{{ unit.leadership|format_price if unit.leadership else 'N/A' }}</td>
						<td>
							<div class="unit-common-params">
								<div>HP: {{ unit.hitpoint if unit.hitpoint else 'N/A' }}</div>
								<div>Defense: {{ unit.defense if unit.defense else 'N/A' }}</div>
								<div class="resistance-list">
									Resistances:
									{% if unit.resistance %}
										{% for res_type, res_value in unit.resistance.items() %}
										<div class="resistance-item ms-2">
											{{ res_type }}: {{ res_value }}%
										</div>
										{% endfor %}
									{% else %}
										<span class="text-muted ms-2">None</span>
									{% endif %}
								</div>
								<div>Attack: {{ unit.attack if unit.attack else 'N/A' }}</div>
								<div>Crit: {{ unit.krit if unit.krit else 'N/A' }}%</div>
								<div>Speed: {{ unit.speed if unit.speed else 'N/A' }}</div>
								<div>
									Movetype:
									{% if unit.movetype %}
										{{ unit.movetype.name|replace('_', ' ')|title }}
									{% else %}
										N/A
									{% endif %}
								</div>
								<div>Initiative: {{ unit.initiative if unit.initiative else 'N/A' }}</div>
							</div>

							<div class="unit-features mt-2">
								{% if unit.features %}
									{% for feature_id, feature_data in unit.features.items() %}
										<span
											class="badge bg-secondary"
											data-bs-toggle="tooltip"
											data-bs-placement="top"
											data-bs-html="true"
											title="{{ feature_data.hint|format_text if feature_data.hint else feature_data.name }}">
											{{ feature_data.name|format_text }}
										</span>{% if not loop.last %}, {% endif %}
									{% endfor %}
								{% else %}
									<span class="text-muted">None</span>
								{% endif %}
							</div>

							<div class="unit-attacks mt-2">
								<strong>Actions:</strong>
								{% if unit.attacks %}
									{% for attack_id, attack_data in unit.attacks.items() %}
										<span
											class="badge bg-danger"
											data-bs-toggle="tooltip"
											data-bs-placement="top"
											data-bs-html="true"
											title="{{ attack_data.hint|format_text if attack_data.hint else attack_data.name }}">
											{{ attack_data.name|format_text }}
										</span>{% if not loop.last %}, {% endif %}
									{% endfor %}
								{% else %}
									<span class="text-muted">None</span>
								{% endif %}
							</div>
						</td>
					</tr>
					{% endfor %}
				</tbody>
			</table>
		</div>
		{% else %}
		<div class="alert alert-info">
			No units found. Scan game files first to populate the database.
		</div>
		{% endif %}

		<div class="mt-3">
			<a href="/games" class="btn btn-secondary">Back to Games</a>
		</div>
	</div>
</div>

<script>
	// Initialize Bootstrap tooltips
	document.addEventListener('DOMContentLoaded', function() {
		var tooltipTriggerList = [].slice.call(document.querySelectorAll('[data-bs-toggle="tooltip"]'));
		var tooltipList = tooltipTriggerList.map(function (tooltipTriggerEl) {
			return new bootstrap.Tooltip(tooltipTriggerEl);
		});
	});

	// Unit list sorting functionality
	document.addEventListener('DOMContentLoaded', function() {
		const sortableHeaders = document.querySelectorAll('.sortable');

		sortableHeaders.forEach(header => {
			header.style.cursor = 'pointer';

			header.addEventListener('click', function() {
				const sortField = this.dataset.sort;
				const currentUrl = new URL(window.location.href);
				const currentSortBy = currentUrl.searchParams.get('sort_by') || 'name';
				const currentSortOrder = currentUrl.searchParams.get('sort_order') || 'asc';

				// Determine new sort order
				let newSortOrder = 'asc';
				if (currentSortBy === sortField && currentSortOrder === 'asc') {
					newSortOrder = 'desc';
				}

				// Update URL parameters
				currentUrl.searchParams.set('sort_by', sortField);
				currentUrl.searchParams.set('sort_order', newSortOrder);

				// Navigate to new URL
				window.location.href = currentUrl.toString();
			});
		});
	});
</script>
{% endblock %}
