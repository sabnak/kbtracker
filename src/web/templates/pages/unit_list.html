{% extends "base.html" %}

{% block title %}Units - King's Bounty Tracker{% endblock %}

{% block content %}
<div class="row">
	<div class="col-md-12">
		<h1 class="mb-4">Units for {{ game.name }}</h1>

		<!-- Profile and Cost Filter Row -->
		{% if profiles %}
		<div class="card mb-4">
			<div class="card-body">
				<form method="GET" action="/games/{{ game.id }}/units">
					<!-- Preserve sort parameters -->
					<input type="hidden" name="sort_by" value="{{ sort_by }}">
					<input type="hidden" name="sort_order" value="{{ sort_order }}">

					<div class="row g-3">
						<div class="col-md-3">
							<label for="profile_id" class="form-label">Profile</label>
							<select
								class="form-select"
								id="profile_id"
								name="profile_id"
								onchange="this.form.submit()">
								<option value="0" {% if not selected_profile_id or selected_profile_id == 0 %}selected{% endif %}>All Profiles</option>
								{% for profile in profiles %}
								<option
									value="{{ profile.id }}"
									{% if selected_profile_id == profile.id %}selected{% endif %}>
									{{ profile.name }}
								</option>
								{% endfor %}
							</select>
						</div>

						<div class="col-md-3">
							<label for="min_cost" class="form-label">Min Cost</label>
							<input
								type="number"
								class="form-control"
								id="min_cost"
								name="min_cost"
								min="0"
								placeholder="Min"
								value="{{ min_cost if min_cost else '' }}">
						</div>

						<div class="col-md-3">
							<label for="max_cost" class="form-label">Max Cost</label>
							<input
								type="number"
								class="form-control"
								id="max_cost"
								name="max_cost"
								min="0"
								placeholder="Max"
								value="{{ max_cost if max_cost else '' }}">
						</div>

						<div class="col-md-3 d-flex align-items-end">
							<button class="btn btn-primary me-2" type="submit">Apply</button>
							<a href="/games/{{ game.id }}/units{% if selected_profile_id %}?profile_id={{ selected_profile_id }}{% endif %}" class="btn btn-secondary">Clear</a>
						</div>
					</div>
				</form>
			</div>
		</div>
		{% endif %}

		<!-- Units Count Info -->
		{% if units %}
		<div class="alert alert-info">
			<strong>Found {{ units|length }} unit(s)</strong>
		</div>
		{% endif %}

		{% if units %}
		<div class="table-responsive">
			<table class="table table-striped table-hover">
				<thead>
					<tr>
						<th class="sortable {% if sort_by == 'name' %}sorted sorted-{{ sort_order }}{% endif %}"
							data-sort="name">
							Name
							<span class="sort-indicator">
								{% if sort_by == 'name' %}
									{% if sort_order == 'asc' %}↑{% else %}↓{% endif %}
								{% else %}
									<span class="hover-icon">↕</span>
								{% endif %}
							</span>
						</th>
						<th class="sortable {% if sort_by == 'race' %}sorted sorted-{{ sort_order }}{% endif %}"
							data-sort="race">
							Race
							<span class="sort-indicator">
								{% if sort_by == 'race' %}
									{% if sort_order == 'asc' %}↑{% else %}↓{% endif %}
								{% else %}
									<span class="hover-icon">↕</span>
								{% endif %}
							</span>
						</th>
						<th class="sortable {% if sort_by == 'level' %}sorted sorted-{{ sort_order }}{% endif %}"
							data-sort="level">
							Level
							<span class="sort-indicator">
								{% if sort_by == 'level' %}
									{% if sort_order == 'asc' %}↑{% else %}↓{% endif %}
								{% else %}
									<span class="hover-icon">↕</span>
								{% endif %}
							</span>
						</th>
						<th class="sortable {% if sort_by == 'cost' %}sorted sorted-{{ sort_order }}{% endif %}"
							data-sort="cost">
							Cost
							<span class="sort-indicator">
								{% if sort_by == 'cost' %}
									{% if sort_order == 'asc' %}↑{% else %}↓{% endif %}
								{% else %}
									<span class="hover-icon">↕</span>
								{% endif %}
							</span>
						</th>
						<th class="sortable {% if sort_by == 'leadership' %}sorted sorted-{{ sort_order }}{% endif %}"
							data-sort="leadership">
							Leadership
							<span class="sort-indicator">
								{% if sort_by == 'leadership' %}
									{% if sort_order == 'asc' %}↑{% else %}↓{% endif %}
								{% else %}
									<span class="hover-icon">↕</span>
								{% endif %}
							</span>
						</th>
						<th>Attributes</th>
						<th>Shops</th>
					</tr>
				</thead>
				<tbody>
					{% for unit in units %}
					<tr>
						<td>
							<strong>{{ unit.name }}</strong><br />
							<small class="text-muted text-xxs">id: {{ unit.id }} kb_id: {{ unit.kb_id }}</small>
						</td>
						<td style="white-space: nowrap;">{{ unit.race if unit.race else 'N/A' }}</td>
						<td style="white-space: nowrap;">
							{% if unit.level %}
							<span class="quality-{{ unit.level }}">{{ unit.level }}</span>
							{% else %}
							N/A
							{% endif %}
						</td>
						<td style="white-space: nowrap;">{{ unit.cost|format_price if unit.cost else 'N/A' }}</td>
						<td style="white-space: nowrap;">{{ unit.leadership|format_price if unit.leadership else 'N/A' }}</td>
						<td>
							<div class="unit-common-params">
								<div>HP: {{ unit.hitpoint if unit.hitpoint else 'N/A' }}</div>
								<div>Defense: {{ unit.defense if unit.defense else 'N/A' }}</div>
								<div class="resistance-list">
									Resistances:
									{% if unit.resistance %}
										{% for res_type, res_value in unit.resistance.items() %}
										<div class="resistance-item ms-2">
											{{ res_type }}: {{ res_value }}%
										</div>
										{% endfor %}
									{% else %}
										<span class="text-muted ms-2">None</span>
									{% endif %}
								</div>
								<div>Attack: {{ unit.attack if unit.attack else 'N/A' }}</div>
								<div>Crit: {{ unit.krit if unit.krit else 'N/A' }}%</div>
								<div>Speed: {{ unit.speed if unit.speed else 'N/A' }}</div>
								<div>
									Movetype:
									{% if unit.movetype %}
										{{ unit.movetype.name|replace('_', ' ')|title }}
									{% else %}
										N/A
									{% endif %}
								</div>
								<div>Initiative: {{ unit.initiative if unit.initiative else 'N/A' }}</div>
							</div>

							<div class="unit-features mt-2">
								{% if unit.features %}
									{% for feature_id, feature_data in unit.features.items() %}
										<span
											class="badge bg-secondary"
											data-bs-toggle="tooltip"
											data-bs-placement="top"
											data-bs-html="true"
											title="{{ feature_data.hint|format_text if feature_data.hint else feature_data.name }}">
											{{ feature_data.name|format_text }}
										</span>{% if not loop.last %}, {% endif %}
									{% endfor %}
								{% else %}
									<span class="text-muted">None</span>
								{% endif %}
							</div>

							<div class="unit-attacks mt-2">
								<strong>Actions:</strong>
								{% if unit.attacks %}
									{% for attack_id, attack_data in unit.attacks.items() %}
										<span
											class="badge bg-danger"
											data-bs-toggle="tooltip"
											data-bs-placement="top"
											data-bs-html="true"
											title="{{ attack_data.hint|format_text if attack_data.hint else attack_data.name }}">
											{{ attack_data.name|format_text }}
										</span>{% if not loop.last %}, {% endif %}
									{% endfor %}
								{% else %}
									<span class="text-muted">None</span>
								{% endif %}
							</div>
						</td>
						<td>
							{% if selected_profile_id %}
								<!-- For Sale Section -->
								{% set unit_for_sale_shops = shops_for_sale.get(unit.id, []) %}
								{% if unit_for_sale_shops %}
									<div class="mb-2">
										<strong class="text-muted" style="font-size: 0.85em;">For Sale:</strong><br>
										<small>
											{% for shop in unit_for_sale_shops %}
												{% set shop_unit = shop.inventory.get_unit(unit.id) %}
												{{ shop.location_name }}
												{% if shop.shop_loc and shop.shop_loc.name %}
													/ {{ shop.shop_loc.name }}
												{% elif shop.shop_kb_id %}
													/ {{ shop.shop_kb_id }}
												{% endif %}
												{% if shop_unit.count > 1 %} <strong>x{{ shop_unit.count }}</strong>{% endif %}
												{% if not loop.last %}<br>{% endif %}
											{% endfor %}
										</small>
									</div>
								{% endif %}

								<!-- Garrison Section -->
								{% set unit_garrison_shops = shops_garrison.get(unit.id, []) %}
								{% if unit_garrison_shops %}
									<div>
										<strong class="text-muted" style="font-size: 0.85em;">Garrison:</strong><br>
										<small>
											{% for shop in unit_garrison_shops %}
												{% set garrison_unit = shop.inventory.get_garrison_unit(unit.id) %}
												{{ shop.location_name }}
												{% if shop.shop_loc and shop.shop_loc.name %}
													/ {{ shop.shop_loc.name }}
												{% elif shop.shop_kb_id %}
													/ {{ shop.shop_kb_id }}
												{% endif %}
												{% if garrison_unit.count > 1 %} <strong>x{{ garrison_unit.count }}</strong>{% endif %}
												{% if not loop.last %}<br>{% endif %}
											{% endfor %}
										</small>
									</div>
								{% endif %}

								<!-- Show dash only if both sections are empty -->
								{% if not unit_for_sale_shops and not unit_garrison_shops %}
									<small class="text-muted">-</small>
								{% endif %}
							{% else %}
								<small class="text-muted">Select profile</small>
							{% endif %}
						</td>
					</tr>
					{% endfor %}
				</tbody>
			</table>
		</div>
		{% else %}
		<div class="alert alert-info">
			No units found. Scan game files first to populate the database.
		</div>
		{% endif %}

		<div class="mt-3">
			<a href="/games" class="btn btn-secondary">Back to Games</a>
		</div>
	</div>
</div>

<script>
	// Initialize Bootstrap tooltips
	document.addEventListener('DOMContentLoaded', function() {
		var tooltipTriggerList = [].slice.call(document.querySelectorAll('[data-bs-toggle="tooltip"]'));
		var tooltipList = tooltipTriggerList.map(function (tooltipTriggerEl) {
			return new bootstrap.Tooltip(tooltipTriggerEl);
		});
	});

	// Unit list sorting functionality
	document.addEventListener('DOMContentLoaded', function() {
		const sortableHeaders = document.querySelectorAll('.sortable');

		sortableHeaders.forEach(header => {
			header.style.cursor = 'pointer';

			header.addEventListener('click', function() {
				const sortField = this.dataset.sort;
				const currentUrl = new URL(window.location.href);
				const currentSortBy = currentUrl.searchParams.get('sort_by') || 'name';
				const currentSortOrder = currentUrl.searchParams.get('sort_order') || 'asc';

				// Determine new sort order
				let newSortOrder = 'asc';
				if (currentSortBy === sortField && currentSortOrder === 'asc') {
					newSortOrder = 'desc';
				}

				// Update URL parameters
				currentUrl.searchParams.set('sort_by', sortField);
				currentUrl.searchParams.set('sort_order', newSortOrder);

				// Preserve filter parameters
				const profileId = currentUrl.searchParams.get('profile_id');
				const minCost = currentUrl.searchParams.get('min_cost');
				const maxCost = currentUrl.searchParams.get('max_cost');
				if (profileId) currentUrl.searchParams.set('profile_id', profileId);
				if (minCost) currentUrl.searchParams.set('min_cost', minCost);
				if (maxCost) currentUrl.searchParams.set('max_cost', maxCost);

				// Navigate to new URL
				window.location.href = currentUrl.toString();
			});
		});
	});
</script>
{% endblock %}
