{% extends "base.html" %}

{% block title %}{% if game.last_scan_time %}{{ _('ui.scan.title_rescan') }}{% else %}{{ _('ui.scan.title_scan') }}{% endif %} {{ _('ui.scan.game_files') }} - {{ _('ui.navigation.brand_name') }}{% endblock %}

{% block content %}
<script>
	document.body.dataset.lastScanTime = '{{ game.last_scan_time if game.last_scan_time else "" }}';
</script>

<div class="row justify-content-center">
	<div class="col-md-8">
		<h1 class="mb-4">
			{% if game.last_scan_time %}{{ _('ui.scan.title_rescan') }}{% else %}{{ _('ui.scan.title_scan') }}{% endif %} {{ _('ui.scan.game_files') }}
		</h1>

		<div class="alert alert-info">
			<strong>{{ _('ui.scan.game_label') }}:</strong> {{ game.name }}<br>
			<strong>{{ _('ui.scan.path_label') }}:</strong> {{ game.path }}
		</div>

		{% if game.last_scan_time %}
		<div class="alert alert-danger">
			<strong>⚠️ {{ _('ui.scan.warning_title') }}:</strong> {{ _('ui.scan.warning_previously_scanned') }}
			{{ game.last_scan_time.strftime('%Y-%m-%d %H:%M') }}.
			{{ _('ui.scan.warning_rescan_deletes') }}
		</div>
		{% endif %}

		<!-- Scan Form (hidden during scan) -->
		<div id="scan-form-container" class="card">
			<div class="card-body">
				<form id="scan-form">
					<div class="mb-3">
						<label for="language" class="form-label">{{ _('ui.scan.select_language') }}</label>
						<select class="form-select" id="language" name="language" required>
							<option value="">{{ _('ui.scan.choose_language') }}</option>
							{% for lang in languages %}
							<option value="{{ lang.value }}">{{ lang.label }}</option>
							{% endfor %}
						</select>
						<div class="form-text">{{ _('ui.scan.language_help') }}</div>
					</div>

					<div class="d-grid gap-2">
						<button type="submit" class="btn btn-primary" id="start-scan-btn">
							{{ _('ui.scan.start_scan') }}
						</button>
						<a href="/games" class="btn btn-secondary">{{ _('ui.common.back_to_games') }}</a>
					</div>
				</form>
			</div>
		</div>

		<!-- Progress Display (hidden initially) -->
		<div id="scan-progress-container" class="card" style="display: none;">
			<div class="card-body">
				<h5 class="card-title">{{ _('ui.scan.scanning_in_progress') }}</h5>
				<hr>

				<!-- Progress List -->
				<ul class="list-group list-group-flush" id="progress-list">
					<li class="list-group-item d-flex justify-content-between align-items-center"
						data-resource="extraction">
						<span>
							<span class="status-icon">⏸️</span>
							<span class="resource-label">{{ _('ui.scan.resource_extraction') }}</span>
						</span>
						<span class="badge bg-secondary count-badge" style="display: none;">0</span>
					</li>
					<li class="list-group-item d-flex justify-content-between align-items-center"
						data-resource="localizations">
						<span>
							<span class="status-icon">⏸️</span>
							<span class="resource-label">{{ _('ui.scan.resource_localizations') }}</span>
						</span>
						<span class="badge bg-secondary count-badge" style="display: none;">0</span>
					</li>
					<li class="list-group-item d-flex justify-content-between align-items-center"
						data-resource="items">
						<span>
							<span class="status-icon">⏸️</span>
							<span class="resource-label">{{ _('ui.scan.resource_items') }}</span>
						</span>
						<span class="badge bg-secondary count-badge" style="display: none;">0</span>
					</li>
					<li class="list-group-item d-flex justify-content-between align-items-center"
						data-resource="sets">
						<span>
							<span class="status-icon">⏸️</span>
							<span class="resource-label">{{ _('ui.scan.resource_sets') }}</span>
						</span>
						<span class="badge bg-secondary count-badge" style="display: none;">0</span>
					</li>
					<li class="list-group-item d-flex justify-content-between align-items-center"
						data-resource="units">
						<span>
							<span class="status-icon">⏸️</span>
							<span class="resource-label">{{ _('ui.scan.resource_units') }}</span>
						</span>
						<span class="badge bg-secondary count-badge" style="display: none;">0</span>
					</li>
					<li class="list-group-item d-flex justify-content-between align-items-center"
						data-resource="spells">
						<span>
							<span class="status-icon">⏸️</span>
							<span class="resource-label">{{ _('ui.scan.resource_spells') }}</span>
						</span>
						<span class="badge bg-secondary count-badge" style="display: none;">0</span>
					</li>
					<li class="list-group-item d-flex justify-content-between align-items-center"
						data-resource="atoms">
						<span>
							<span class="status-icon">⏸️</span>
							<span class="resource-label">{{ _('ui.scan.resource_atoms') }}</span>
						</span>
						<span class="badge bg-secondary count-badge" style="display: none;">0</span>
					</li>
				</ul>

				<!-- Status Message -->
				<div class="mt-3">
					<small class="text-muted" id="status-message">{{ _('ui.scan.status_initializing') }}</small>
				</div>
			</div>
		</div>

		<!-- Results Display (shown on completion) -->
		<div id="scan-results-container" class="alert alert-success" style="display: none;">
			<strong>{{ _('ui.scan.complete') }}</strong><br>
			<span id="results-summary"></span>
			<hr>
			<a href="/games/{{ game.id }}/items" class="btn btn-sm btn-success">{{ _('ui.scan.view_items') }}</a>
			<button class="btn btn-sm btn-primary" id="scan-again-btn">{{ _('ui.scan.scan_again') }}</button>
		</div>

		<!-- Error Display (shown on error) -->
		<div id="scan-error-container" class="alert alert-danger" style="display: none;">
			<h5 class="alert-heading">
				<strong>{{ _('ui.scan.failed') }}</strong>
				<span id="error-type-badge" class="badge bg-danger ms-2" style="display: none;"></span>
			</h5>
			<div id="error-message" class="mb-3"></div>
			<div id="error-details-container" style="display: none;">
				<button class="btn btn-sm btn-outline-danger mb-2" type="button"
						data-bs-toggle="collapse" data-bs-target="#error-traceback"
						aria-expanded="false" aria-controls="error-traceback">
					{{ _('ui.scan.show_technical_details') }}
				</button>
				<div class="collapse" id="error-traceback">
					<div class="card card-body bg-dark text-light">
						<pre id="error-traceback-content" class="mb-0" style="font-size: 0.85rem; max-height: 400px; overflow-y: auto;"></pre>
					</div>
				</div>
			</div>
			<hr>
			<button class="btn btn-sm btn-primary" id="retry-scan-btn">{{ _('ui.scan.try_again') }}</button>
		</div>

		<div class="alert alert-secondary mt-4">
			<h5>{{ _('ui.scan.note_title') }}:</h5>
			<p>{{ _('ui.scan.note_text_1') }}
			   {{ _('ui.scan.note_text_2') }}
			   <code>/data/{{ game.path }}/</code></p>
		</div>
	</div>
</div>

<script src="{{ url_for('static', path='/js/scan-progress.js') }}"></script>
{% endblock %}
