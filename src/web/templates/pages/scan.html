{% extends "base.html" %}

{% block title %}{% if game.last_scan_time %}Rescan{% else %}Scan{% endif %} Game Files - King's Bounty Tracker{% endblock %}

{% block content %}
<script>
	document.body.dataset.lastScanTime = '{{ game.last_scan_time if game.last_scan_time else "" }}';
</script>

<div class="row justify-content-center">
	<div class="col-md-8">
		<h1 class="mb-4">
			{% if game.last_scan_time %}Rescan{% else %}Scan{% endif %} Game Files
		</h1>

		<div class="alert alert-info">
			<strong>Game:</strong> {{ game.name }}<br>
			<strong>Path:</strong> {{ game.path }}
		</div>

		{% if game.last_scan_time %}
		<div class="alert alert-danger">
			<strong>⚠️ WARNING:</strong> This game was previously scanned on
			{{ game.last_scan_time.strftime('%Y-%m-%d %H:%M') }}.
			Rescanning will <strong>permanently delete all existing data</strong> including items, atoms, and profiles!
		</div>
		{% endif %}

		<!-- Scan Form (hidden during scan) -->
		<div id="scan-form-container" class="card">
			<div class="card-body">
				<form id="scan-form">
					<div class="mb-3">
						<label for="language" class="form-label">Select Language</label>
						<select class="form-select" id="language" name="language" required>
							<option value="">Choose language...</option>
							{% for lang in languages %}
							<option value="{{ lang.value }}">{{ lang.label }}</option>
							{% endfor %}
						</select>
						<div class="form-text">Select the game language version to scan</div>
					</div>

					<div class="d-grid gap-2">
						<button type="submit" class="btn btn-primary" id="start-scan-btn">
							Start Scan
						</button>
						<a href="/games" class="btn btn-secondary">Back to Games</a>
					</div>
				</form>
			</div>
		</div>

		<!-- Progress Display (hidden initially) -->
		<div id="scan-progress-container" class="card" style="display: none;">
			<div class="card-body">
				<h5 class="card-title">Scanning in Progress...</h5>
				<hr>

				<!-- Progress List -->
				<ul class="list-group list-group-flush" id="progress-list">
					<li class="list-group-item d-flex justify-content-between align-items-center"
						data-resource="extraction">
						<span>
							<span class="status-icon">⏸️</span>
							<span class="resource-label">Archive Extraction</span>
						</span>
						<span class="badge bg-secondary count-badge" style="display: none;">0</span>
					</li>
					<li class="list-group-item d-flex justify-content-between align-items-center"
						data-resource="localizations">
						<span>
							<span class="status-icon">⏸️</span>
							<span class="resource-label">Localizations</span>
						</span>
						<span class="badge bg-secondary count-badge" style="display: none;">0</span>
					</li>
					<li class="list-group-item d-flex justify-content-between align-items-center"
						data-resource="items">
						<span>
							<span class="status-icon">⏸️</span>
							<span class="resource-label">Items</span>
						</span>
						<span class="badge bg-secondary count-badge" style="display: none;">0</span>
					</li>
					<li class="list-group-item d-flex justify-content-between align-items-center"
						data-resource="sets">
						<span>
							<span class="status-icon">⏸️</span>
							<span class="resource-label">Item Sets</span>
						</span>
						<span class="badge bg-secondary count-badge" style="display: none;">0</span>
					</li>
					<li class="list-group-item d-flex justify-content-between align-items-center"
						data-resource="units">
						<span>
							<span class="status-icon">⏸️</span>
							<span class="resource-label">Units</span>
						</span>
						<span class="badge bg-secondary count-badge" style="display: none;">0</span>
					</li>
					<li class="list-group-item d-flex justify-content-between align-items-center"
						data-resource="spells">
						<span>
							<span class="status-icon">⏸️</span>
							<span class="resource-label">Spells</span>
						</span>
						<span class="badge bg-secondary count-badge" style="display: none;">0</span>
					</li>
					<li class="list-group-item d-flex justify-content-between align-items-center"
						data-resource="atoms">
						<span>
							<span class="status-icon">⏸️</span>
							<span class="resource-label">Atoms</span>
						</span>
						<span class="badge bg-secondary count-badge" style="display: none;">0</span>
					</li>
				</ul>

				<!-- Status Message -->
				<div class="mt-3">
					<small class="text-muted" id="status-message">Initializing scan...</small>
				</div>
			</div>
		</div>

		<!-- Results Display (shown on completion) -->
		<div id="scan-results-container" class="alert alert-success" style="display: none;">
			<strong>Scan Complete!</strong><br>
			<span id="results-summary"></span>
			<hr>
			<a href="/games/{{ game.id }}/items" class="btn btn-sm btn-success">View Items</a>
			<button class="btn btn-sm btn-primary" id="scan-again-btn">Scan Again</button>
		</div>

		<!-- Error Display (shown on error) -->
		<div id="scan-error-container" class="alert alert-danger" style="display: none;">
			<h5 class="alert-heading">
				<strong>Scan Failed</strong>
				<span id="error-type-badge" class="badge bg-danger ms-2" style="display: none;"></span>
			</h5>
			<div id="error-message" class="mb-3"></div>
			<div id="error-details-container" style="display: none;">
				<button class="btn btn-sm btn-outline-danger mb-2" type="button"
						data-bs-toggle="collapse" data-bs-target="#error-traceback"
						aria-expanded="false" aria-controls="error-traceback">
					Show Technical Details
				</button>
				<div class="collapse" id="error-traceback">
					<div class="card card-body bg-dark text-light">
						<pre id="error-traceback-content" class="mb-0" style="font-size: 0.85rem; max-height: 400px; overflow-y: auto;"></pre>
					</div>
				</div>
			</div>
			<hr>
			<button class="btn btn-sm btn-primary" id="retry-scan-btn">Try Again</button>
		</div>

		<div class="alert alert-secondary mt-4">
			<h5>Note:</h5>
			<p>The scanner will read game data files from the mounted game directory.
			   Make sure the game files are accessible in the Docker container at
			   <code>/data/{{ game.path }}/</code></p>
		</div>
	</div>
</div>

<script src="{{ url_for('static', path='/js/scan-progress.js') }}"></script>
{% endblock %}
