{% extends "base.html" %}

{% block title %}{{ _('ui.items') }} - {{ _('ui.navigation.brand_name') }}{% endblock %}

{% block content %}
<div class="row">
	<div class="col-md-12" data-game-id="{{ game.id }}">
		<h1 class="mb-4">{{ _('ui.item.title_for') }} {{ game.name }}</h1>

		<div class="card mb-4">
			<div class="card-body">
				<form method="GET" action="/games/{{ game.id }}/items">
					<input type="hidden" name="id" value="{{ selected_id or '' }}">

					<!-- Profile Filter Row -->
					{% if profiles %}
					<div class="row g-3 mb-3">
						<div class="col-md-4">
							<label for="profile_id" class="form-label">{{ _('ui.item.profile_label') }}</label>
							<select
								class="form-select"
								id="profile_id"
								name="profile_id"
								onchange="this.form.submit()">
								<option value="0" {% if not selected_profile_id or selected_profile_id == 0 %}selected{% endif %}>{{ _('ui.item.all_profiles') }}</option>
								{% for profile in profiles %}
								<option
									value="{{ profile.id }}"
									{% if selected_profile_id == profile.id %}selected{% endif %}>
									{{ profile.name }}
								</option>
								{% endfor %}
							</select>
						</div>
					</div>
					{% endif %}

					<div class="row g-3">
						<!-- Name Search -->
						<div class="col-md-5">
							<label for="query" class="form-label">{{ _('ui.item.item_name_label') }}</label>
							<input
								type="text"
								class="form-control"
								id="query"
								name="query"
								placeholder="{{ _('ui.item.search_by_name') }}"
								value="{{ query }}">
						</div>

						<!-- Level Filter -->
						<div class="col-md-2">
							<label for="level" class="form-label">{{ _('ui.item.level_label') }}</label>
							<select class="form-select" id="level" name="level">
								<option value="">{{ _('ui.item.all_levels') }}</option>
								{% for lvl in available_levels %}
								<option value="{{ lvl }}" {% if selected_level == lvl %}selected{% endif %}>
									{{ _('ui.item.level_value') }} {{ lvl }}
								</option>
								{% endfor %}
							</select>
						</div>

						<!-- Type (Propbit) Filter -->
						<div class="col-md-2">
							<label class="form-label">{{ _('ui.item.type_label') }}</label>
							<div class="dropdown w-100">
								<button class="btn btn-outline-secondary dropdown-toggle w-100 text-start" type="button" id="propbitDropdown" data-bs-toggle="dropdown" data-bs-auto-close="outside" aria-expanded="false">
									<span id="propbitButtonText">{{ _('ui.item.all_types') }}</span>
								</button>
								<div class="dropdown-menu w-100" aria-labelledby="propbitDropdown" style="max-height: 900px; overflow-y: auto;">
									<div class="px-3 py-2">
										{% for pb in available_propbits %}
										<div class="form-check">
											<input class="form-check-input propbit-checkbox" type="checkbox" name="propbit" value="{{ pb }}" id="propbit_{{ pb }}" {% if pb in selected_propbits %}checked{% endif %}>
											<label class="form-check-label" for="propbit_{{ pb }}">
												{{ pb|capitalize }}
											</label>
										</div>
										{% endfor %}
									</div>
								</div>
							</div>
						</div>

						<!-- Hint Regex Search -->
						<div class="col-md-6">
							<label for="hint_regex" class="form-label">{{ _('ui.item.description_pattern_label') }}</label>
							<input
								type="text"
								class="form-control"
								id="hint_regex"
								name="hint_regex"
								placeholder="{{ _('ui.item.regex_placeholder') }}"
								value="{{ hint_regex }}">
							<div class="form-text">{{ _('ui.item.regex_help') }}</div>
						</div>

						<!-- Item Set Filter -->
						<div class="col-md-6">
							<label for="item_set_id" class="form-label">{{ _('ui.item.item_set_label') }}</label>
							<select class="form-select" id="item_set_id" name="item_set_id">
								<option value="">{{ _('ui.item.all_sets_no_set') }}</option>
								{% for item_set in available_sets %}
								<option value="{{ item_set.id }}" {% if selected_set_id == item_set.id %}selected{% endif %}>
									{{ item_set.name }}
								</option>
								{% endfor %}
							</select>
						</div>

						<!-- Buttons -->
						<div class="col-12">
							<button class="btn btn-primary" type="submit">{{ _('ui.item.apply_filters') }}</button>
							<a href="/games/{{ game.id }}/items{% if selected_profile_id %}?profile_id={{ selected_profile_id }}{% endif %}" class="btn btn-secondary">{{ _('ui.item.clear_all') }}</a>
						</div>
					</div>
				</form>
			</div>
		</div>

		<!-- Items Count Info -->
		{% if items_with_sets %}
		<div class="alert alert-info">
			<strong>{{ _('ui.item.found_items_count', count=items_with_sets|length) }}</strong>
			{% if query or selected_level or hint_regex or selected_propbits or selected_set_id or selected_profile_id %}
				{{ _('ui.item.matching_filter_criteria') }}
			{% endif %}
		</div>
		{% endif %}

		{% if error %}
		<div class="alert alert-danger">
			<strong>{{ _('ui.item.error_label') }}:</strong> {{ error }}
		</div>
		{% endif %}

		{% if items_with_sets %}
		<div class="table-responsive">
			<table class="table table-striped table-hover">
				<thead>
					<tr>
						<th class="sortable {% if sort_by == 'name' %}sorted sorted-{{ sort_order }}{% endif %}"
							data-sort="name">
							{{ _('ui.item.name_header') }}
							<span class="sort-indicator">
								{% if sort_by == 'name' %}
									{% if sort_order == 'asc' %}↑{% else %}↓{% endif %}
								{% else %}
									<span class="hover-icon">↕</span>
								{% endif %}
							</span>
						</th>
						<th class="sortable {% if sort_by == 'price' %}sorted sorted-{{ sort_order }}{% endif %}"
							data-sort="price">
							{{ _('ui.item.price_header') }}
							<span class="sort-indicator">
								{% if sort_by == 'price' %}
									{% if sort_order == 'asc' %}↑{% else %}↓{% endif %}
								{% else %}
									<span class="hover-icon">↕</span>
								{% endif %}
							</span>
						</th>
						<th class="sortable {% if sort_by == 'level' %}sorted sorted-{{ sort_order }}{% endif %}"
							data-sort="level">
							{{ _('ui.item.level_header') }}
							<span class="sort-indicator">
								{% if sort_by == 'level' %}
									{% if sort_order == 'asc' %}↑{% else %}↓{% endif %}
								{% else %}
									<span class="hover-icon">↕</span>
								{% endif %}
							</span>
						</th>
						<th style="max-width: 100px;">{{ _('ui.item.type_header') }}</th>
						<th>{{ _('ui.item.inventory') }}</th>
					</tr>
				</thead>
				<tbody>
					{% for item_data in items_with_sets %}
					{% set item = item_data.item %}
					<tr data-item-id="{{ item.id }}">
						<td>
							<strong>{{ item.name }}</strong><br>
							{% if item.hint %}
							<small class="text-muted">{{ item.hint|format_text|safe }}</small>
							{% else %}
							<small class="text-muted">{{ _('ui.item.no_description') }}</small>
							{% endif %}

							{% if item_data.item_set %}
							<div class="set-info">
								{% if item_data.item_set.hint %}
								<div class="set-hint">
									<strong>{{ _('ui.item.set_label') }}: {{ item_data.item_set.name }}</strong><br>
									{{ item_data.item_set.hint|format_text|safe }}
								</div>
								{% endif %}

								{% if item_data.set_items %}
								<ul class="set-items">
									{% for set_item in item_data.set_items %}
									<li class="{% if set_item.id == item.id %}current-item{% endif %}">
										{% if set_item.id == item.id %}
											{{ set_item.name }}
										{% else %}
											<a href="/games/{{ game.id }}/items?id={{ set_item.id }}" class="related-item-link">{{ set_item.name }}</a>
										{% endif %}
									</li>
									{% endfor %}
								</ul>
								{% endif %}
							</div>
							{% endif %}

							{% if item.tiers and item.tiers|length > 1 %}
							<br />
							<div class="tier-info">
								<ul class="tier-items">
									{% for tier_item in item_data.tier_items %}
									<li>
										{% if tier_item.id == item.id %}
											<strong>{{ tier_item.name }}</strong>
										{% else %}
											<a href="/games/{{ game.id }}/items?id={{ tier_item.id }}" class="related-item-link">{{ tier_item.name }}</a>
										{% endif %}
									</li>
									{% endfor %}
								</ul>
							</div>
							{% endif %}

							<br /><br />
							<small class="text-muted text-xxs">id: {{ item.id }} kb_id: {{ item.kb_id }}</small>
						</td>
						<td>{{ item.price|format_price }}</td>
						<td>
							<span class="quality-{{ item.level }}">{{ item.level }}</span>
						</td>
						<td style="max-width: 100px;">
							{% if item.propbits %}
							<small>{{ ', '.join(item.propbits[:3]) }}</small>
							{% else %}
							-
							{% endif %}
						</td>
						<td>
							{% if selected_profile_id %}
								{% set item_shops = shops_by_item.get(item.id, []) %}
								{% set in_hero_inventory = item.id in hero_items_set %}

								{% if item_shops or in_hero_inventory %}
									<small>
										{# Display shops section #}
										{% if item_shops %}
											{% for shop in item_shops %}
												{% set shop_item = shop.inventory.get_item(item.id) %}
												{{ shop.location_name }}
												/ {{ shop.shop_loc.name or shop.shop_loc.hint|format_text|safe }}
												{% if shop_item.count > 1 %} <strong>{{ shop_item.count }}</strong>{% endif %}
												<br>
											{% endfor %}
										{% endif %}

										{# Display hero inventory section #}
										{% if in_hero_inventory %}
											{% if item_shops %}<hr style="margin: 0.5rem 0;">{% endif %}
											{% set hero_item = hero_items_dict.get(item.id) %}
											<strong>{{ _('ui.item.hero') }}</strong>
											{% if hero_item and hero_item.count > 1 %} <strong>{{ hero_item.count }}</strong>{% endif %}
										{% endif %}
									</small>
								{% else %}
									<small class="text-muted">-</small>
								{% endif %}
							{% else %}
								<small class="text-muted">{{ _('ui.item.select_profile') }}</small>
							{% endif %}
						</td>
					</tr>
					{% endfor %}
				</tbody>
			</table>
		</div>
		{% else %}
		<div class="alert alert-info">
			{{ _('ui.item.no_items_found') }}
			{% if query or selected_level or hint_regex or selected_propbits or selected_set_id or selected_profile_id %}
				{{ _('ui.item.try_adjust_filters') }}
			{% else %}
				{{ _('ui.item.scan_first') }}
			{% endif %}
		</div>
		{% endif %}

		<div class="mt-3">
			<a href="/games" class="btn btn-secondary">{{ _('ui.common.back_to_games') }}</a>
		</div>
	</div>
</div>

<script>
	const GAME_ID = {{ game.id }};
</script>

<script>
	// Item list sorting functionality
	document.addEventListener('DOMContentLoaded', function() {
		const sortableHeaders = document.querySelectorAll('.sortable');

		sortableHeaders.forEach(header => {
			header.style.cursor = 'pointer';

			header.addEventListener('click', function() {
				const sortField = this.dataset.sort;
				const currentUrl = new URL(window.location.href);
				const currentSortBy = currentUrl.searchParams.get('sort_by') || 'name';
				const currentSortOrder = currentUrl.searchParams.get('sort_order') || 'asc';

				// Determine new sort order
				let newSortOrder = 'asc';
				if (currentSortBy === sortField && currentSortOrder === 'asc') {
					newSortOrder = 'desc';
				}

				// Update URL parameters
				currentUrl.searchParams.set('sort_by', sortField);
				currentUrl.searchParams.set('sort_order', newSortOrder);

				// Navigate to new URL (preserves all existing filters)
				window.location.href = currentUrl.toString();
			});
		});
	});
</script>

<script>
	// Propbit multi-select dropdown functionality
	document.addEventListener('DOMContentLoaded', function() {
		const checkboxes = document.querySelectorAll('.propbit-checkbox');
		const buttonText = document.getElementById('propbitButtonText');

		function updateButtonText() {
			const checkedCount = document.querySelectorAll('.propbit-checkbox:checked').length;
			if (checkedCount === 0) {
				buttonText.textContent = 'All Types';
			} else if (checkedCount === 1) {
				const checkedBox = document.querySelector('.propbit-checkbox:checked');
				const label = document.querySelector(`label[for="${checkedBox.id}"]`);
				buttonText.textContent = label.textContent.trim();
			} else {
				buttonText.textContent = `${checkedCount} types selected`;
			}
		}

		// Update button text when checkboxes change
		checkboxes.forEach(checkbox => {
			checkbox.addEventListener('change', updateButtonText);
		});

		// Initialize button text on page load
		updateButtonText();
	});
</script>
{% endblock %}
