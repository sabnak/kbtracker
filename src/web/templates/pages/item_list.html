{% extends "base.html" %}

{% block title %}Items - King's Bounty Tracker{% endblock %}

{% block content %}
<div class="row">
	<div class="col-md-12">
		<h1 class="mb-4">Items for {{ game.name }}</h1>

		<div class="card mb-4">
			<div class="card-body">
				<form method="GET" action="/games/{{ game.id }}/items">
					<div class="row g-3">
						<!-- Name Search -->
						<div class="col-md-6">
							<label for="query" class="form-label">Item Name</label>
							<input
								type="text"
								class="form-control"
								id="query"
								name="query"
								placeholder="Search by name..."
								value="{{ query }}">
						</div>

						<!-- Level Filter -->
						<div class="col-md-3">
							<label for="level" class="form-label">Level</label>
							<select class="form-select" id="level" name="level">
								<option value="">All Levels</option>
								{% for lvl in available_levels %}
								<option value="{{ lvl }}" {% if selected_level == lvl %}selected{% endif %}>
									Level {{ lvl }}
								</option>
								{% endfor %}
							</select>
						</div>

						<!-- Type (Propbit) Filter -->
						<div class="col-md-3">
							<label for="propbit" class="form-label">Type</label>
							<select class="form-select" id="propbit" name="propbit">
								<option value="">All Types</option>
								{% for pb in available_propbits %}
								<option value="{{ pb }}" {% if selected_propbit == pb %}selected{% endif %}>
									{{ pb|capitalize }}
								</option>
								{% endfor %}
							</select>
						</div>

						<!-- Hint Regex Search -->
						<div class="col-md-6">
							<label for="hint_regex" class="form-label">Description Pattern (Regex)</label>
							<input
								type="text"
								class="form-control"
								id="hint_regex"
								name="hint_regex"
								placeholder="e.g., .*magic.*|.*spell.*"
								value="{{ hint_regex }}">
							<div class="form-text">PostgreSQL regex pattern (case-insensitive)</div>
						</div>

						<!-- Item Set Filter -->
						<div class="col-md-6">
							<label for="item_set_id" class="form-label">Item Set</label>
							<select class="form-select" id="item_set_id" name="item_set_id">
								<option value="">All Sets / No Set</option>
								{% for item_set in available_sets %}
								<option value="{{ item_set.id }}" {% if selected_set_id == item_set.id %}selected{% endif %}>
									{{ item_set.name }}
								</option>
								{% endfor %}
							</select>
						</div>

						<!-- Buttons -->
						<div class="col-12">
							<button class="btn btn-primary" type="submit">Apply Filters</button>
							<a href="/games/{{ game.id }}/items" class="btn btn-secondary">Clear All</a>
						</div>
					</div>
				</form>
			</div>
		</div>

		{% if error %}
		<div class="alert alert-danger">
			<strong>Error:</strong> {{ error }}
		</div>
		{% endif %}

		{% if items_with_sets %}
		<div class="table-responsive">
			<table class="table table-striped table-hover">
				<thead>
					<tr>
						<th class="sortable {% if sort_by == 'name' %}sorted sorted-{{ sort_order }}{% endif %}"
							data-sort="name">
							Name
							<span class="sort-indicator">
								{% if sort_by == 'name' %}
									{% if sort_order == 'asc' %}↑{% else %}↓{% endif %}
								{% else %}
									<span class="hover-icon">↕</span>
								{% endif %}
							</span>
						</th>
						<th class="sortable {% if sort_by == 'price' %}sorted sorted-{{ sort_order }}{% endif %}"
							data-sort="price">
							Price
							<span class="sort-indicator">
								{% if sort_by == 'price' %}
									{% if sort_order == 'asc' %}↑{% else %}↓{% endif %}
								{% else %}
									<span class="hover-icon">↕</span>
								{% endif %}
							</span>
						</th>
						<th class="sortable {% if sort_by == 'level' %}sorted sorted-{{ sort_order }}{% endif %}"
							data-sort="level">
							Level
							<span class="sort-indicator">
								{% if sort_by == 'level' %}
									{% if sort_order == 'asc' %}↑{% else %}↓{% endif %}
								{% else %}
									<span class="hover-icon">↕</span>
								{% endif %}
							</span>
						</th>
						<th>Type</th>
					</tr>
				</thead>
				<tbody>
					{% for item_data in items_with_sets %}
					{% set item = item_data.item %}
					<tr>
						<td>
							<strong>{{ item.name }}</strong><br>
							{% if item.hint %}
							<small class="text-muted">{{ item.hint|format_text|safe }}</small>
							{% else %}
							<small class="text-muted">No description</small>
							{% endif %}

							{% if item_data.item_set %}
							<div class="set-info">
								{% if item_data.item_set.hint %}
								<div class="set-hint">
									<strong>Set: {{ item_data.item_set.name }}</strong><br>
									{{ item_data.item_set.hint|format_text|safe }}
								</div>
								{% endif %}

								{% if item_data.set_items %}
								<ul class="set-items">
									{% for set_item in item_data.set_items %}
									<li class="{% if set_item.id == item.id %}current-item{% endif %}">
										{{ set_item.name }}
									</li>
									{% endfor %}
								</ul>
								{% endif %}
							</div>
							{% endif %}
						</td>
						<td>{{ item.price|format_price }}</td>
						<td>
							<span class="quality-{{ item.level }}">{{ item.level }}</span>
						</td>
						<td>
							{% if item.propbits %}
							<small>{{ ', '.join(item.propbits[:3]) }}</small>
							{% else %}
							-
							{% endif %}
						</td>
					</tr>
					{% endfor %}
				</tbody>
			</table>
		</div>
		{% else %}
		<div class="alert alert-info">
			No items found.
			{% if query or selected_level or hint_regex or selected_propbit or selected_set_id %}
				Try adjusting your filter criteria.
			{% else %}
				Scan game files first to populate the database.
			{% endif %}
		</div>
		{% endif %}

		<div class="alert alert-secondary mt-4">
			<h5>Note:</h5>
			<p>This is a read-only view of game items. To track items to shops, visit a profile's "View Tracked Items" page.</p>
		</div>

		<div class="mt-3">
			<a href="/games" class="btn btn-secondary">Back to Games</a>
		</div>
	</div>
</div>

<script>
	// Item list sorting functionality
	document.addEventListener('DOMContentLoaded', function() {
		const sortableHeaders = document.querySelectorAll('.sortable');

		sortableHeaders.forEach(header => {
			header.style.cursor = 'pointer';

			header.addEventListener('click', function() {
				const sortField = this.dataset.sort;
				const currentUrl = new URL(window.location.href);
				const currentSortBy = currentUrl.searchParams.get('sort_by') || 'name';
				const currentSortOrder = currentUrl.searchParams.get('sort_order') || 'asc';

				// Determine new sort order
				let newSortOrder = 'asc';
				if (currentSortBy === sortField && currentSortOrder === 'asc') {
					newSortOrder = 'desc';
				}

				// Update URL parameters
				currentUrl.searchParams.set('sort_by', sortField);
				currentUrl.searchParams.set('sort_order', newSortOrder);

				// Navigate to new URL (preserves all existing filters)
				window.location.href = currentUrl.toString();
			});
		});
	});
</script>
{% endblock %}
