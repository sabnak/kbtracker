{% extends "base.html" %}

{% block title %}Spells - King's Bounty Tracker{% endblock %}

{% block content %}
<div class="row">
	<div class="col-md-12">
		<h1 class="mb-4">Spells for {{ game.name }}</h1>

		<!-- Profile and School Filter Row -->
		{% if profiles %}
		<div class="card mb-4">
			<div class="card-body">
				<form method="GET" action="/games/{{ game.id }}/spells">
					<!-- Preserve sort parameters -->
					<input type="hidden" name="sort_by" value="{{ sort_by }}">
					<input type="hidden" name="sort_order" value="{{ sort_order }}">

					<div class="row g-3">
						<div class="col-md-4">
							<label for="profile_id" class="form-label">Profile</label>
							<select
								class="form-select"
								id="profile_id"
								name="profile_id"
								onchange="this.form.submit()">
								<option value="0" {% if not selected_profile_id or selected_profile_id == 0 %}selected{% endif %}>All Profiles</option>
								{% for profile in profiles %}
								<option
									value="{{ profile.id }}"
									{% if selected_profile_id == profile.id %}selected{% endif %}>
									{{ profile.name }}
								</option>
								{% endfor %}
							</select>
						</div>

						<div class="col-md-4">
							<label for="school" class="form-label">School</label>
							<select class="form-select" id="school" name="school">
								<option value="">All Schools</option>
								{% for school_enum in all_schools %}
								<option
									value="{{ school_enum.name }}"
									{% if selected_school == school_enum %}selected{% endif %}>
									{{ school_enum.name|replace('_', ' ')|title }}
								</option>
								{% endfor %}
							</select>
						</div>

						<div class="col-md-4 d-flex align-items-end">
							<button class="btn btn-primary me-2" type="submit">Apply</button>
							<a href="/games/{{ game.id }}/spells{% if selected_profile_id %}?profile_id={{ selected_profile_id }}{% endif %}" class="btn btn-secondary">Clear</a>
						</div>
					</div>
				</form>
			</div>
		</div>
		{% endif %}

		<!-- Spells Count Info -->
		{% if spells %}
		<div class="alert alert-info">
			<strong>Found {{ spells|length }} spell(s)</strong>
		</div>
		{% endif %}

		{% if spells %}
		<div class="table-responsive">
			<table class="table table-striped table-hover">
				<thead>
					<tr>
						<th class="sortable {% if sort_by == 'name' %}sorted sorted-{{ sort_order }}{% endif %}"
							data-sort="name" style="white-space: nowrap;">
							Name
							<span class="sort-indicator">
								{% if sort_by == 'name' %}
									{% if sort_order == 'asc' %}↑{% else %}↓{% endif %}
								{% else %}
									<span class="hover-icon">↕</span>
								{% endif %}
							</span>
						</th>
						<th class="sortable {% if sort_by == 'school' %}sorted sorted-{{ sort_order }}{% endif %}"
							data-sort="school" style="white-space: nowrap;">
							School
							<span class="sort-indicator">
								{% if sort_by == 'school' %}
									{% if sort_order == 'asc' %}↑{% else %}↓{% endif %}
								{% else %}
									<span class="hover-icon">↕</span>
								{% endif %}
							</span>
						</th>
						<th class="sortable {% if sort_by == 'mana' %}sorted sorted-{{ sort_order }}{% endif %}"
							data-sort="mana" style="white-space: nowrap;">
							Mana
							<span class="sort-indicator">
								{% if sort_by == 'mana' %}
									{% if sort_order == 'asc' %}↑{% else %}↓{% endif %}
								{% else %}
									<span class="hover-icon">↕</span>
								{% endif %}
							</span>
						</th>
						<th class="sortable {% if sort_by == 'crystal' %}sorted sorted-{{ sort_order }}{% endif %}"
							data-sort="crystal" style="white-space: nowrap;">
							Crystal
							<span class="sort-indicator">
								{% if sort_by == 'crystal' %}
									{% if sort_order == 'asc' %}↑{% else %}↓{% endif %}
								{% else %}
									<span class="hover-icon">↕</span>
								{% endif %}
							</span>
						</th>
						<th>Effect</th>
						<th>Shops</th>
					</tr>
				</thead>
				<tbody>
					{% for spell in spells %}
					<tr>
						<td style="white-space: nowrap;">
							<strong>{{ spell.loc.name if spell.loc and spell.loc.name else 'N/A' }}</strong><br />
							<small class="text-muted text-xxs">kb_id: {{ spell.kb_id }}</small>
						</td>
						<td style="white-space: nowrap;">
							{{ spell.school.name|replace('_', ' ')|title }}
						</td>
						<td style="white-space: nowrap;">
							{% if spell.mana_cost %}
								{{ spell.mana_cost|join(' / ') }}
							{% else %}
								-
							{% endif %}
						</td>
						<td style="white-space: nowrap;">
							{% if spell.crystal_cost %}
								{{ spell.crystal_cost|join(' / ') }}
							{% else %}
								-
							{% endif %}
						</td>
						<td>
							{% if spell.loc %}
								{% if spell.loc.desc %}
									{{ spell.loc.desc|format_text|safe }}
								{% endif %}

								{% if spell.loc.desc_list %}
									{% if spell.loc.desc %}<br><br>{% endif %}
									{% for desc_item in spell.loc.desc_list %}
										{{ desc_item|format_text|safe }}
										{% if not loop.last %}<br><br>{% endif %}
									{% endfor %}
								{% endif %}

								{% if spell.loc.text %}
									{% if spell.loc.desc or spell.loc.desc_list %}<br><br>{% endif %}
									{{ spell.loc.text|format_text|safe }}
								{% endif %}

								{% if spell.loc.text_list %}
									{% if spell.loc.desc or spell.loc.desc_list or spell.loc.text %}<br><br>{% endif %}
									{% for text_item in spell.loc.text_list %}
										{{ text_item|format_text|safe }}
										{% if not loop.last %}<br><br>{% endif %}
									{% endfor %}
								{% endif %}
							{% else %}
								<span class="text-muted">No description available</span>
							{% endif %}
						</td>
						<td>
							{% if selected_profile_id %}
								{% set spell_shops = shops_by_spell.get(spell.id, []) %}
								{% if spell_shops %}
									<small>
										{% for shop in spell_shops %}
											{% set shop_spell = shop.inventory.get_spell(spell.id) %}
											{{ shop.location_name }}
											{% if shop.shop_loc and shop.shop_loc.name %}
												/ {{ shop.shop_loc.name }}
											{% elif shop.shop_kb_id %}
												/ {{ shop.shop_kb_id }}
											{% endif %}
											{% if shop_spell.count > 1 %} <strong>{{ shop_spell.count }}</strong>{% endif %}
											{% if not loop.last %}<br>{% endif %}
										{% endfor %}
									</small>
								{% else %}
									<small class="text-muted">-</small>
								{% endif %}
							{% else %}
								<small class="text-muted">Select profile</small>
							{% endif %}
						</td>
					</tr>
					{% endfor %}
				</tbody>
			</table>
		</div>
		{% else %}
		<div class="alert alert-info">
			No spells found. Scan game files first to populate the database.
		</div>
		{% endif %}

		<div class="mt-3">
			<a href="/games" class="btn btn-secondary">Back to Games</a>
		</div>
	</div>
</div>

<script>
document.addEventListener('DOMContentLoaded', function() {
	const sortableHeaders = document.querySelectorAll('.sortable');

	sortableHeaders.forEach(header => {
		header.style.cursor = 'pointer';

		header.addEventListener('click', function() {
			const sortField = this.dataset.sort;
			const currentUrl = new URL(window.location.href);
			const currentSortBy = currentUrl.searchParams.get('sort_by') || 'name';
			const currentSortOrder = currentUrl.searchParams.get('sort_order') || 'asc';

			// Toggle sort order if clicking same field
			let newSortOrder = 'asc';
			if (currentSortBy === sortField && currentSortOrder === 'asc') {
				newSortOrder = 'desc';
			}

			// Update URL and navigate
			currentUrl.searchParams.set('sort_by', sortField);
			currentUrl.searchParams.set('sort_order', newSortOrder);
			window.location.href = currentUrl.toString();
		});
	});
});
</script>
{% endblock %}
