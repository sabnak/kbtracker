{% extends "base.html" %}

{% block title %}{{ _('ui.units') }} - {{ _('ui.navigation.brand_name') }}{% endblock %}

{% block content %}
<div class="row">
	<div class="col-md-12">
		<h1 class="mb-4">{{ _('ui.unit.title_for') }} {{ game.name }}</h1>

		<!-- Unit Filters -->
		{% if profiles %}
		<div class="card mb-4">
			<div class="card-body">
				<form method="GET" action="/games/{{ game.id }}/units">
					<!-- Preserve sort parameters -->
					<input type="hidden" name="sort_by" value="{{ sort_by }}">
					<input type="hidden" name="sort_order" value="{{ sort_order }}">

					<!-- Row 1: Profile Filter (alone) -->
					<div class="row g-3 mb-3">
						<div class="col-md-4">
							<label for="profile_id" class="form-label">{{ _('ui.item.profile_label') }}</label>
							<select
								class="form-select"
								id="profile_id"
								name="profile_id"
								onchange="this.form.submit()">
								<option value="0" {% if not selected_profile_id or selected_profile_id == 0 %}selected{% endif %}>{{ _('ui.item.all_profiles') }}</option>
								{% for profile in profiles %}
								<option
									value="{{ profile.id }}"
									{% if selected_profile_id == profile.id %}selected{% endif %}>
									{{ profile.name }}
								</option>
								{% endfor %}
							</select>
						</div>
					</div>

					<!-- Row 2: Cost Filters -->
					<div class="row g-3 mb-3">
						<div class="col-md-2">
							<label for="min_cost" class="form-label">{{ _('ui.unit.min_cost_label') }}</label>
							<input
								type="number"
								class="form-control"
								id="min_cost"
								name="min_cost"
								min="0"
								value="{{ filters.min_cost if filters.min_cost else '' }}">
						</div>
						<div class="col-md-2">
							<label for="max_cost" class="form-label">{{ _('ui.unit.max_cost_label') }}</label>
							<input
								type="number"
								class="form-control"
								id="max_cost"
								name="max_cost"
								min="0"
								value="{{ filters.max_cost if filters.max_cost else '' }}">
						</div>
					</div>

					<!-- Row 3: Numeric Attributes -->
					<div class="row g-3 mb-3">
						<div class="col-md-2">
							<label for="min_attack" class="form-label">{{ _('ui.unit.attack_label') }}</label>
							<input
								type="number"
								class="form-control"
								id="min_attack"
								name="min_attack"
								min="0"
								value="{{ filters.min_attack if filters.min_attack else '' }}">
						</div>
						<div class="col-md-2">
							<label for="min_krit" class="form-label">{{ _('ui.unit.krit_label') }}</label>
							<input
								type="number"
								class="form-control"
								id="min_krit"
								name="min_krit"
								min="0"
								value="{{ filters.min_krit if filters.min_krit else '' }}">
						</div>
						<div class="col-md-2">
							<label for="min_hitpoint" class="form-label">{{ _('ui.unit.hp_label') }}</label>
							<input
								type="number"
								class="form-control"
								id="min_hitpoint"
								name="min_hitpoint"
								min="0"
								value="{{ filters.min_hitpoint if filters.min_hitpoint else '' }}">
						</div>
						<div class="col-md-2">
							<label for="min_defense" class="form-label">{{ _('ui.unit.defense_label') }}</label>
							<input
								type="number"
								class="form-control"
								id="min_defense"
								name="min_defense"
								min="0"
								value="{{ filters.min_defense if filters.min_defense else '' }}">
						</div>
						<div class="col-md-2">
							<label for="min_speed" class="form-label">{{ _('ui.unit.speed_label') }}</label>
							<input
								type="number"
								class="form-control"
								id="min_speed"
								name="min_speed"
								min="0"
								value="{{ filters.min_speed if filters.min_speed else '' }}">
						</div>
						<div class="col-md-2">
							<label for="min_initiative" class="form-label">{{ _('ui.unit.initiative_label') }}</label>
							<input
								type="number"
								class="form-control"
								id="min_initiative"
								name="min_initiative"
								min="0"
								value="{{ filters.min_initiative if filters.min_initiative else '' }}">
						</div>
					</div>

					<!-- Resistances Title -->
					<div class="row mb-2">
						<div class="col-12">
							<h6 class="mb-0">{{ _('ui.unit.resistances_title') }}</h6>
						</div>
					</div>

					<!-- Row 4: Resistance Filters -->
					<div class="row g-3 mb-3">
						<div class="col-md-2">
							<label for="min_resistance_fire" class="form-label">{{ _('ui.unit.resistance_fire_label') }}</label>
							<input
								type="number"
								class="form-control"
								id="min_resistance_fire"
								name="min_resistance_fire"
								min="-80"
								max="80"
								value="{{ filters.min_resistance_fire if filters.min_resistance_fire else '' }}">
						</div>
						<div class="col-md-2">
							<label for="min_resistance_magic" class="form-label">{{ _('ui.unit.resistance_magic_label') }}</label>
							<input
								type="number"
								class="form-control"
								id="min_resistance_magic"
								name="min_resistance_magic"
								min="-80"
								max="80"
								value="{{ filters.min_resistance_magic if filters.min_resistance_magic else '' }}">
						</div>
						<div class="col-md-2">
							<label for="min_resistance_poison" class="form-label">{{ _('ui.unit.resistance_poison_label') }}</label>
							<input
								type="number"
								class="form-control"
								id="min_resistance_poison"
								name="min_resistance_poison"
								min="-80"
								max="80"
								value="{{ filters.min_resistance_poison if filters.min_resistance_poison else '' }}">
						</div>
						<div class="col-md-2">
							<label for="min_resistance_glacial" class="form-label">{{ _('ui.unit.resistance_glacial_label') }}</label>
							<input
								type="number"
								class="form-control"
								id="min_resistance_glacial"
								name="min_resistance_glacial"
								min="-80"
								max="80"
								value="{{ filters.min_resistance_glacial if filters.min_resistance_glacial else '' }}">
						</div>
						<div class="col-md-2">
							<label for="min_resistance_physical" class="form-label">{{ _('ui.unit.resistance_physical_label') }}</label>
							<input
								type="number"
								class="form-control"
								id="min_resistance_physical"
								name="min_resistance_physical"
								min="-80"
								max="80"
								value="{{ filters.min_resistance_physical if filters.min_resistance_physical else '' }}">
						</div>
						<div class="col-md-2">
							<label for="min_resistance_astral" class="form-label">{{ _('ui.unit.resistance_astral_label') }}</label>
							<input
								type="number"
								class="form-control"
								id="min_resistance_astral"
								name="min_resistance_astral"
								min="-80"
								max="80"
								value="{{ filters.min_resistance_astral if filters.min_resistance_astral else '' }}">
						</div>
					</div>

					<!-- Row 5: Level + Action Buttons -->
					<div class="row g-3">
						<div class="col-md-2">
							<label for="level" class="form-label">{{ _('ui.unit.level_label') }}</label>
							<select
								class="form-select"
								id="level"
								name="level">
								<option value="">{{ _('ui.common.all') }}</option>
								<option value="1" {% if filters.level == 1 %}selected{% endif %}>1</option>
								<option value="2" {% if filters.level == 2 %}selected{% endif %}>2</option>
								<option value="3" {% if filters.level == 3 %}selected{% endif %}>3</option>
								<option value="4" {% if filters.level == 4 %}selected{% endif %}>4</option>
								<option value="5" {% if filters.level == 5 %}selected{% endif %}>5</option>
							</select>
						</div>
						<div class="col-md-4 d-flex align-items-end">
							<button class="btn btn-primary me-2" type="submit">{{ _('ui.item.apply_filters') }}</button>
							<a href="/games/{{ game.id }}/units{% if selected_profile_id %}?profile_id={{ selected_profile_id }}{% endif %}" class="btn btn-secondary">{{ _('ui.item.clear_all') }}</a>
						</div>
					</div>
				</form>
			</div>
		</div>
		{% endif %}

		<!-- Units Count Info -->
		{% if units %}
		<div class="alert alert-info">
			<strong>{{ _('ui.unit.found_units_count', count=units|length) }}</strong>
		</div>
		{% endif %}

		{% if units %}
		<div class="table-responsive">
			<table class="table table-striped table-hover">
				<thead>
					<tr>
						<th class="sortable {% if sort_by == 'name' %}sorted sorted-{{ sort_order }}{% endif %}"
							data-sort="name">
							{{ _('ui.item.name_header') }}
							<span class="sort-indicator">
								{% if sort_by == 'name' %}
									{% if sort_order == 'asc' %}↑{% else %}↓{% endif %}
								{% else %}
									<span class="hover-icon">↕</span>
								{% endif %}
							</span>
						</th>
						<th class="sortable {% if sort_by == 'race' %}sorted sorted-{{ sort_order }}{% endif %}"
							data-sort="race">
							{{ _('ui.unit.race_header') }}
							<span class="sort-indicator">
								{% if sort_by == 'race' %}
									{% if sort_order == 'asc' %}↑{% else %}↓{% endif %}
								{% else %}
									<span class="hover-icon">↕</span>
								{% endif %}
							</span>
						</th>
						<th class="sortable {% if sort_by == 'level' %}sorted sorted-{{ sort_order }}{% endif %}"
							data-sort="level">
							{{ _('ui.item.level_header') }}
							<span class="sort-indicator">
								{% if sort_by == 'level' %}
									{% if sort_order == 'asc' %}↑{% else %}↓{% endif %}
								{% else %}
									<span class="hover-icon">↕</span>
								{% endif %}
							</span>
						</th>
						<th class="sortable {% if sort_by == 'cost' %}sorted sorted-{{ sort_order }}{% endif %}"
							data-sort="cost">
							{{ _('ui.unit.cost_header') }}
							<span class="sort-indicator">
								{% if sort_by == 'cost' %}
									{% if sort_order == 'asc' %}↑{% else %}↓{% endif %}
								{% else %}
									<span class="hover-icon">↕</span>
								{% endif %}
							</span>
						</th>
						<th class="sortable {% if sort_by == 'leadership' %}sorted sorted-{{ sort_order }}{% endif %}"
							data-sort="leadership">
							{{ _('ui.unit.leadership_header') }}
							<span class="sort-indicator">
								{% if sort_by == 'leadership' %}
									{% if sort_order == 'asc' %}↑{% else %}↓{% endif %}
								{% else %}
									<span class="hover-icon">↕</span>
								{% endif %}
							</span>
						</th>
						<th>{{ _('ui.unit.attributes_header') }}</th>
						<th>{{ _('ui.shops') }}</th>
					</tr>
				</thead>
				<tbody>
					{% for unit in units %}
					<tr>
						<td>
							<strong>{{ unit.name }}</strong><br />
							<small class="text-muted text-xxs">id: {{ unit.id }} kb_id: {{ unit.kb_id }}</small>
						</td>
						<td style="white-space: nowrap;">{{ unit.race if unit.race else 'N/A' }}</td>
						<td style="white-space: nowrap;">
							{% if unit.level %}
							<span class="quality-{{ unit.level }}">{{ unit.level }}</span>
							{% else %}
							N/A
							{% endif %}
						</td>
						<td style="white-space: nowrap;">{{ unit.cost|format_price if unit.cost else 'N/A' }}</td>
						<td style="white-space: nowrap;">{{ unit.leadership|format_price if unit.leadership else 'N/A' }}</td>
						<td>
							<div class="unit-common-params">
								<div>{{ _('ui.unit.hp_label') }}: {{ unit.hitpoint if unit.hitpoint else 'N/A' }}</div>
								<div>{{ _('ui.unit.defense_label') }}: {{ unit.defense if unit.defense else 'N/A' }}</div>
								<div class="resistance-list">
									{{ _('ui.unit.resistances_label') }}:
									{% if unit.resistance %}
										{% for res_type, res_value in unit.resistance.items() %}
										<div class="resistance-item ms-2">
											{{ _("ui.unit.resistance_" + res_type + "_label") }}: {{ res_value }}%
										</div>
										{% endfor %}
									{% else %}
										<span class="text-muted ms-2">{{ _('ui.common.none') }}</span>
									{% endif %}
								</div>
								<div>{{ _('ui.unit.attack_label') }}: {{ unit.attack if unit.attack else 'N/A' }}</div>
								<div>{{ _('ui.unit.crit_label') }}: {{ unit.krit if unit.krit else 'N/A' }}%</div>
								<div>{{ _('ui.unit.speed_label') }}: {{ unit.speed if unit.speed else 'N/A' }}</div>
								<div>{{ _('ui.unit.initiative_label') }}: {{ unit.initiative if unit.initiative else 'N/A' }}</div>
							</div>

							<div class="unit-features mt-2">
								{% if unit.features %}
									{% for feature_id, feature_data in unit.features.items() %}
										<span
											class="badge bg-secondary"
											data-bs-toggle="tooltip"
											data-bs-placement="top"
											data-bs-html="true"
											title="{{ feature_data.hint|format_text if feature_data.hint else feature_data.name }}">
											{{ feature_data.name|format_text }}
										</span>{% if not loop.last %}, {% endif %}
									{% endfor %}
								{% else %}
									<span class="text-muted">{{ _('ui.common.none') }}</span>
								{% endif %}
							</div>

							<div class="unit-attacks mt-2">
								<strong>{{ _('ui.unit.actions_label') }}</strong>
								{% if unit.attacks %}
									{% for attack_id, attack_data in unit.attacks.items() %}
										<span
											class="badge bg-danger"
											data-bs-toggle="tooltip"
											data-bs-placement="top"
											data-bs-html="true"
											title="{{ attack_data.hint|format_text if attack_data.hint else attack_data.name }}">
											{{ attack_data.name|format_text }}
										</span>{% if not loop.last %}, {% endif %}
									{% endfor %}
								{% else %}
									<span class="text-muted">{{ _('ui.common.none') }}</span>
								{% endif %}
							</div>
						</td>
						<td>
							{% if selected_profile_id %}
								<!-- For Sale Section -->
								{% set unit_for_sale_shops = shops_for_sale.get(unit.id, []) %}
								{% if unit_for_sale_shops %}
									<div class="mb-2">
										<strong class="text-muted" style="font-size: 0.85em;">{{ _('ui.unit.for_sale_label') }}</strong><br>
										<small>
											{% for shop in unit_for_sale_shops %}
												{% set shop_unit = shop.inventory.get_unit(unit.id) %}
												{{ shop.location_name }}
												{% if shop.shop_loc %}
													/ {{ shop.shop_loc.caption|format_text }}
												{% elif shop.shop_kb_id %}
													/ {{ shop.shop_kb_id }}
												{% endif %}
												{% if shop_unit.count > 1 %} <strong>x{{ shop_unit.count }}</strong>{% endif %}
												{% if not loop.last %}<br>{% endif %}
											{% endfor %}
										</small>
									</div>
								{% endif %}

								<!-- Garrison Section -->
								{% set unit_garrison_shops = shops_garrison.get(unit.id, []) %}
								{% if unit_garrison_shops %}
									<div>
										<strong class="text-muted" style="font-size: 0.85em;">{{ _('ui.shop.garrison_label') }}</strong><br>
										<small>
											{% for shop in unit_garrison_shops %}
												{% set garrison_unit = shop.inventory.get_garrison_unit(unit.id) %}
												{{ shop.location_name }}
												{% if shop.shop_loc and shop.shop_loc.name %}
													/ {{ shop.shop_loc.name }}
												{% elif shop.shop_kb_id %}
													/ {{ shop.shop_kb_id }}
												{% endif %}
												{% if garrison_unit.count > 1 %} <strong>x{{ garrison_unit.count }}</strong>{% endif %}
												{% if not loop.last %}<br>{% endif %}
											{% endfor %}
										</small>
									</div>
								{% endif %}

								<!-- Show dash only if both sections are empty -->
								{% if not unit_for_sale_shops and not unit_garrison_shops %}
									<small class="text-muted">-</small>
								{% endif %}
							{% else %}
								<small class="text-muted">{{ _('ui.item.select_profile') }}</small>
							{% endif %}
						</td>
					</tr>
					{% endfor %}
				</tbody>
			</table>
		</div>
		{% else %}
		<div class="alert alert-info">
			{{ _('ui.unit.no_units_found') }}
		</div>
		{% endif %}

		<div class="mt-3">
			<a href="/games" class="btn btn-secondary">{{ _('ui.common.back_to_games') }}</a>
		</div>
	</div>
</div>

<script>
	// Initialize Bootstrap tooltips
	document.addEventListener('DOMContentLoaded', function() {
		var tooltipTriggerList = [].slice.call(document.querySelectorAll('[data-bs-toggle="tooltip"]'));
		var tooltipList = tooltipTriggerList.map(function (tooltipTriggerEl) {
			return new bootstrap.Tooltip(tooltipTriggerEl);
		});
	});

	// Unit list sorting functionality
	document.addEventListener('DOMContentLoaded', function() {
		const sortableHeaders = document.querySelectorAll('.sortable');

		sortableHeaders.forEach(header => {
			header.style.cursor = 'pointer';

			header.addEventListener('click', function() {
				const sortField = this.dataset.sort;
				const currentUrl = new URL(window.location.href);
				const currentSortBy = currentUrl.searchParams.get('sort_by') || 'name';
				const currentSortOrder = currentUrl.searchParams.get('sort_order') || 'asc';

				// Determine new sort order
				let newSortOrder = 'asc';
				if (currentSortBy === sortField && currentSortOrder === 'asc') {
					newSortOrder = 'desc';
				}

				// Update URL parameters
				currentUrl.searchParams.set('sort_by', sortField);
				currentUrl.searchParams.set('sort_order', newSortOrder);

				// Preserve filter parameters
				const filters = [
					'profile_id', 'min_cost', 'max_cost',
					'min_attack', 'min_krit', 'min_hitpoint', 'min_defense', 'min_speed', 'min_initiative',
					'min_resistance_fire', 'min_resistance_magic', 'min_resistance_poison',
					'min_resistance_glacial', 'min_resistance_physical', 'min_resistance_astral',
					'level'
				];

				filters.forEach(filterName => {
					const value = currentUrl.searchParams.get(filterName);
					if (value) currentUrl.searchParams.set(filterName, value);
				});

				// Navigate to new URL
				window.location.href = currentUrl.toString();
			});
		});
	});
</script>
{% endblock %}
