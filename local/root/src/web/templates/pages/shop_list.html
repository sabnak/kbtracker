{% extends "base.html" %}

{% block title %}{{ _('ui.shops') }} - {{ _('ui.navigation.brand_name') }}{% endblock %}

{% block content %}
<div class="row">
	<div class="col-md-12">
		<h1 class="mb-4">{{ _('ui.shop.title_for') }} {{ game.name }}</h1>

		<!-- Profile Filter -->
		{% if profiles %}
		<div class="card mb-4">
			<div class="card-body">
				<form method="GET" action="/games/{{ game.id }}/shops">
					<div class="row">
						<div class="col-md-4">
							<label for="profile_id" class="form-label">{{ _('ui.shop.profile_label') }}</label>
							<select
								class="form-select"
								id="profile_id"
								name="profile_id"
								onchange="this.form.submit()">
								{% for profile in profiles %}
								<option
									value="{{ profile.id }}"
									{% if selected_profile_id == profile.id %}selected{% endif %}>
									{{ profile.name }}
								</option>
								{% endfor %}
							</select>
						</div>
					</div>
				</form>
			</div>
		</div>
		{% endif %}

		<!-- Shops by Location -->
		{% if locations %}
			{% for location_name, shops in locations.items() %}
			<div class="location-section mb-5">
				<h2 class="mb-3">{{ location_name }}</h2>

				<!-- Shop Grid (2 per row) -->
				<div class="row">
					{% for shop in shops %}
					<div class="col-md-6 mb-4">
						<div class="card shop-card">
							<div class="card-header d-flex justify-content-between align-items-center">
								<strong>
									{% if shop.shop_loc and shop.shop_loc.name %}
										{{ shop.shop_loc.name }}
									{% elif shop.shop_loc and shop.shop_loc.hint %}
										{{ shop.shop_loc.hint | format_text | safe }}
									{% else %}
										{{ shop.shop_kb_id }}
									{% endif %}
								</strong>
								<small class="text-muted">{{ shop.shop_kb_id }}</small>
							</div>
							<div class="card-body p-0">
								<table class="table table-sm mb-0">
									<thead>
										<tr>
											<th class="shop-col-3">{{ _('ui.items') }}</th>
											<th class="shop-col-3">{{ _('ui.spells') }}</th>
											<th class="shop-col-3">{{ _('ui.units') }}</th>
										</tr>
									</thead>
									<tbody>
										<tr>
											<!-- Items Column -->
											<td class="shop-col-3">
												{% if shop.inventory.items %}
												<div class="shop-inventory-list {% if shop.inventory.items|length > 10 %}scrollable{% endif %}">
													<ul class="list-unstyled mb-0">
														{% for shop_item in shop.inventory.items %}
														<li class="shop-item" style="display: flex; justify-content: space-between;">
															<span>
																<a href="/games/{{ game.id }}/items?id={{ shop_item.item.id }}">{{ shop_item.item.name }}</a>
																{% if shop_item.count > 1 %}
																<strong>{{ shop_item.count }}</strong>
																{% endif %}
															</span>
															<span class="shop-cost">{{ shop_item.item.price|format_price }}</span>
														</li>
														{% endfor %}
													</ul>
												</div>
												{% else %}
												<span class="text-muted">-</span>
												{% endif %}
											</td>

											<!-- Spells Column -->
											<td class="shop-col-3">
												{% if shop.inventory.spells %}
												<div class="shop-inventory-list {% if shop.inventory.spells|length > 10 %}scrollable{% endif %}">
													<ul class="list-unstyled mb-0">
														{% for shop_spell in shop.inventory.spells %}
														<li class="shop-item" style="display: flex; justify-content: space-between;">
															<span>
																{{ shop_spell.spell.loc.name }}
																{% if shop_spell.count > 1 %}
																<strong>{{ shop_spell.count }}</strong>
																{% endif %}
															</span>
															<span class="shop-cost">{{ shop_spell.spell.price|format_price }}</span>
														</li>
														{% endfor %}
													</ul>
												</div>
												{% else %}
												<span class="text-muted">-</span>
												{% endif %}
											</td>

											<!-- Units Column -->
											<td class="shop-col-3">
												{% if shop.inventory.units %}
												<div class="shop-inventory-list {% if shop.inventory.units|length > 10 %}scrollable{% endif %}">
													<ul class="list-unstyled mb-0">
														{% for shop_unit in shop.inventory.units %}
														<li class="shop-item" style="display: flex; justify-content: space-between;">
															<span>
																{{ shop_unit.unit.name }}
																{% if shop_unit.count > 1 %}
																<strong>{{ shop_unit.count }}</strong>
																{% endif %}
															</span>
															<span class="shop-cost">{{ shop_unit.unit.cost|format_price }}</span>
														</li>
														{% endfor %}
													</ul>
												</div>
												{% else %}
												<span class="text-muted">-</span>
												{% endif %}
											</td>
										</tr>
									</tbody>
								</table>
								{% if shop.inventory.garrison %}
								<div class="shop-garrison">
									<strong>{{ _('ui.shop.garrison_label') }}:</strong>
									<ul class="list-unstyled mb-0" style="margin-left: 0; padding-left: 0;">
										{% for garrison_unit in shop.inventory.garrison %}
										<li style="display: flex; justify-content: space-between;">
											<span>
												{{ garrison_unit.unit.name }}
												{% if garrison_unit.count > 1 %}
												<strong>{{ garrison_unit.count }}</strong>
												{% endif %}
											</span>
										</li>
										{% endfor %}
									</ul>
								</div>
								{% endif %}
							</div>
						</div>
					</div>
					{% endfor %}
				</div>
			</div>
			{% endfor %}
		{% else %}
			{% if profiles %}
			<div class="alert alert-info">
				{{ _('ui.shop.no_inventory_found') }}
			</div>
			{% else %}
			<div class="alert alert-info">
				{{ _('ui.shop.no_profiles_create_first') }}
			</div>
			{% endif %}
		{% endif %}

		<div class="mt-3">
			<a href="/games" class="btn btn-secondary">{{ _('ui.common.back_to_games') }}</a>
		</div>
	</div>
</div>
{% endblock %}
